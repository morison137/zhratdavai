<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Давай жрать!</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />

  <!-- Telegram WebApp JS (опционально) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Шрифты -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

  <style>
    :root {
      --primary-color: #FF6B35;
      --text-color: #1E1F23;
      --text-secondary: #6D6E76;
      --background-color: #F7F7F9;
      --card-background: #FFFFFF;
      --button-color: #F1F2F4;
      --button-text: #3C3D43;
      --button-hover: #E6E7EB;
      --shadow-sm: 0 6px 18px rgba(18, 18, 23, 0.06);
      --shadow-md: 0 10px 28px rgba(18, 18, 23, 0.10);
      --radius-xl: 20px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --text-color: #EDEEF2;
        --text-secondary: #B3B6BF;
        --background-color: #121316;
        --card-background: #1A1B20;
        --button-color: #2A2C33;
        --button-text: #EDEEF2;
        --button-hover: #323542;
        --shadow-sm: 0 6px 18px rgba(0,0,0,0.35);
        --shadow-md: 0 12px 30px rgba(0,0,0,0.45);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(255,107,53,0.08), transparent),
                  var(--background-color);
      color: var(--text-color);
      margin: 0;
      line-height: 1.55;
      letter-spacing: 0.2px;
      margin-bottom: 120px; /* под нижний бар */
      margin-top: 72px;     /* под верхний бар */
      -webkit-tap-highlight-color: transparent;
    }

    .container {
      padding-left: 18px;
      padding-right: 18px;
      max-width: 560px;
      margin: 0 auto;
    }

    /* ===== Карточки ===== */
    .card {
      border: none;
      border-radius: var(--radius-lg);
      background-color: var(--card-background);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

    .media-wrapper {
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .card-img-top {
      width: 100%;
      aspect-ratio: 3 / 4;      /* вертикальные, акцент на фото */
      object-fit: cover;
      background: #E9EAEE;
      display: block;
      transition: filter .18s ease, transform .18s ease;
    }

    .card.selected .card-img-top {
      filter: saturate(1.05) contrast(1.02);
    }

    /* Плашка с названием (второстепенно) */
    .img-label {
      position: absolute;
      inset: auto 0 0 0;
      padding: 10px 12px;
      background: linear-gradient(to top, rgba(0,0,0,0.55), rgba(0,0,0,0.0));
      color: #fff;
      display: flex;
      align-items: end;
      min-height: 72px;
    }
    .dish-name {
      font-size: .92rem;
      font-weight: 600;
      opacity: .95;
    }

    /* Кнопка-переключатель (плюс/галка) */
    .img-toggle {
      position: absolute;
      top: 10px; right: 10px;
      width: 44px; height: 44px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.45);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      transition: transform .16s ease, background .16s ease;
      cursor: pointer;
    }
    .img-toggle:hover { transform: translateY(-1px); }
    .img-toggle:active { transform: translateY(0); }
    .img-toggle svg { width: 22px; height: 22px; }
    .img-toggle .icon-check { display: none; }
    .img-toggle.active { background: var(--primary-color); }
    .img-toggle.active .icon-plus { display: none; }
    .img-toggle.active .icon-check { display: block; }

    .hidden { display: none !important; }

    /* ===== Заголовки категорий ===== */
    #dishesContainer > h4 {
      font-size: 1.05rem;
      font-weight: 800;
      margin: 28px 0 14px;
      color: var(--text-color);
      letter-spacing: -0.2px;
    }

    /* ===== Верхняя панель категорий ===== */
    .category-bar {
      position: fixed;
      top: 0; left: 0; width: 100%;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow-sm);
      padding: 10px 8px;
      overflow-x: auto;
      white-space: nowrap;
      z-index: 10000;
      scrollbar-width: none;
    }
    .category-bar::-webkit-scrollbar { display: none; }
    .category-bar .category-btn {
      display: inline-flex;
      align-items: center;
      border: none;
      background: transparent;
      color: var(--text-color);
      margin-right: 8px;
      padding: 8px 14px;
      border-radius: 9999px;
      transition: background .18s ease, transform .18s ease;
      font-size: .92rem;
    }
    .category-bar .category-btn:hover { background: var(--button-hover); }
    .category-bar .category-btn.active {
      background: var(--button-color);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
    }

    /* ===== Нижний переключатель ===== */
    .bottom-switcher {
      position: fixed;
      bottom: 22px; left: 50%;
      transform: translateX(-50%);
      width: min(92%, 360px);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      align-items: center;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
      border-radius: 9999px;
      padding: 8px;
      z-index: 9999;
    }
    .switch-btn {
      border: none;
      background: transparent;
      color: var(--text-color);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-radius: 9999px;
      font-weight: 600;
      padding: 10px 14px;
      transition: background .18s ease, transform .18s ease;
      text-align: center;
      font-size: .95rem;
    }
    .switch-btn:hover { background: var(--button-hover); }
    .switch-btn.active { background: var(--text-color); color: white; }
    .counter-badge {
      background: rgba(0,0,0,0.10);
      padding: 2px 9px;
      border-radius: 9999px;
      font-size: .75rem;
      font-weight: 700;
      line-height: 1.3;
    }
    .switch-btn.active .counter-badge { background: rgba(255,255,255,0.25); color: #fff; }

    /* ===== Раздел «Хочу!» ===== */
    #wantSection { padding-bottom: 108px; }
    #wantSection h4 {
      font-size: 1.4rem;
      font-weight: 800;
      margin: 0;
      letter-spacing: -0.3px;
    }
    #clearBtn {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: .9rem;
      font-weight: 600;
    }
    #clearBtn:hover { color: var(--text-color); }

    /* ===== Кнопка «Отправить жене» ===== */
    .share-btn-container {
      position: fixed;
      bottom: 92px;
      left: 50%;
      transform: translateX(-50%);
      width: min(92%, 360px);
      display: none; /* по умолчанию скрыта */
      z-index: 9998;
    }
    #shareBtn {
      width: 100%;
      background: var(--primary-color);
      color: #fff;
      font-weight: 800;
      border-radius: 9999px;
      padding: 15px 26px;
      box-shadow: 0 10px 24px rgba(255,107,53,.35);
      border: none;
      transition: transform .18s ease, filter .18s ease;
    }
    #shareBtn:hover { transform: translateY(-1px); filter: brightness(0.98); }

    /* ===== Пустой список ===== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 42px 16px;
      text-align: center;
      min-height: 300px;
      gap: 12px;
      opacity: .95;
    }
    .empty-state-icon { font-size: 64px; opacity: .6; }
    .empty-state-text { font-size: 1rem; color: var(--text-secondary); max-width: 280px; }

    /* ===== Анимации появления карточек ===== */
    .fade-in-up {
      opacity: 0;
      transform: translateY(8px);
      animation: fadeInUp .35s ease forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Фокус ===== */
    :focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
      border-radius: 14px;
    }

    @media (min-width: 640px) {
      .category-bar, .bottom-switcher {
        background: rgba(255,255,255,0.80);
      }
    }
  </style>
</head>
<body>
  <!-- Верхний бар с категориями -->
  <div id="categoryBar" class="category-bar" role="tablist" aria-label="Категории">
    <!-- динамически здесь -->
  </div>

  <div class="container mt-3">
    <!-- Секция «Меню» -->
    <div id="menuSection" aria-labelledby="menuTab">
      <div id="dishesContainer"><!-- сюда прилетят категории и карточки --></div>
    </div>

    <!-- Секция «Хочу!» -->
    <div id="wantSection" class="hidden" aria-labelledby="wantTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="m-0">Хочу!</h4>
        <button id="clearBtn" class="btn btn-link p-0" type="button" title="Очистить список">Очистить</button>
      </div>

      <div id="wantContent">
        <div class="row row-cols-2 g-3" id="wantGrid"></div>

        <!-- Empty state -->
        <div class="empty-state" id="emptyState" aria-live="polite">
          <div class="empty-state-icon">🍽️</div>
          <p class="empty-state-text">Пока ничего не выбрано. Выберите блюда из меню</p>
          <button id="backToMenuBtn" class="btn btn-light" type="button">Вернуться к меню</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Кнопка «Отправить жене» -->
  <div class="share-btn-container" id="shareBtnContainer">
    <button id="shareBtn" class="btn" type="button" title="Поделиться списком">
      Отправить жене
    </button>
  </div>

  <!-- Нижний переключатель -->
  <div class="bottom-switcher" role="tablist" aria-label="Разделы">
    <button id="menuTab" class="switch-btn active" role="tab" aria-selected="true" aria-controls="menuSection" type="button">
      Меню <span class="counter-badge" id="menuCount">0</span>
    </button>
    <button id="wantTab" class="switch-btn" role="tab" aria-selected="false" aria-controls="wantSection" type="button">
      Хочу! <span class="counter-badge" id="wantCount">0</span>
    </button>
  </div>

  <!-- jQuery + Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    // === Полифилл CSS.escape для старых браузеров ===
    (function() {
      if (typeof window.CSS === "undefined") window.CSS = {};
      if (typeof window.CSS.escape === "function") return;
      window.CSS.escape = function(value) {
        return String(value).replace(/[^a-zA-Z0-9_\u00A0-\uFFFF-]/g, function(ch) {
          var hex = ch.charCodeAt(0).toString(16).toUpperCase();
          return "\\" + hex + " ";
        });
      };
    })();

    // === Telegram WebApp (опционально) ===
    let tg = null;
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
      tg.ready?.();
    }

    // === Глобальные данные ===
    let dishes = [];              // блюда из JSON
    let wantList = [];            // выбранные блюда
    const WANT_STORAGE_KEY = "wantList.v1";
    const LAST_CATEGORY_KEY = "lastCategory.v1";

    // SVG-плейсхолдер
    const PLACEHOLDER_IMG =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="800">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#f2f3f6"/>
              <stop offset="100%" stop-color="#e6e8ee"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="52%" text-anchor="middle" font-family="Inter,Arial" font-size="28" fill="#9aa0a6">Фото блюда</text>
        </svg>
      `);

    function imgOnError(e) {
      const img = e.target;
      img.onerror = null;
      img.src = PLACEHOLDER_IMG;
    }

    // ==== UI helpers ====
    function setActiveCategory(categoryName) {
      const buttons = $("#categoryBar button");
      buttons.each(function() {
        const text = $(this).data("cat");
        if (text === categoryName) {
          $(this).addClass("active").attr("aria-selected", "true");
          this.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
        } else {
          $(this).removeClass("active").attr("aria-selected", "false");
        }
      });
      try { localStorage.setItem(LAST_CATEGORY_KEY, categoryName || ""); } catch(e){}
    }

    function updateShareBtnVisibility() {
      const isWantTabActive = !$("#wantSection").hasClass("hidden");
      if (isWantTabActive && wantList.length > 0) {
        $("#shareBtnContainer").fadeIn(120);
      } else {
        $("#shareBtnContainer").fadeOut(120);
      }
    }

    function updateEmptyState() {
      if (wantList.length === 0) {
        $("#wantGrid").hide();
        $("#emptyState").show();
      } else {
        $("#wantGrid").show();
        $("#emptyState").hide();
      }
      updateShareBtnVisibility();
    }

    // ==== Хранилище ====
    function persistWant() {
      try {
        const ids = wantList.map(d => d.id);
        localStorage.setItem(WANT_STORAGE_KEY, JSON.stringify(ids));
      } catch(e){}
    }

    function restoreWant() {
      try {
        const raw = localStorage.getItem(WANT_STORAGE_KEY);
        if (!raw) return;
        const ids = JSON.parse(raw);
        wantList = dishes.filter(d => ids.includes(d.id));
      } catch(e){}
    }

    // ==== Рендер верхней панели категорий ====
    function renderCategoryBar() {
      const categories = [...new Set(dishes.map(d => d.category))].sort((a,b) => a.localeCompare(b, 'ru'));
      const bar = $("#categoryBar");
      bar.empty();

      categories.forEach(category => {
        const button = $(`<button type="button" class="category-btn" role="tab" aria-selected="false"></button>`);
        button.text(category);
        button.attr("data-cat", category);
        button.on("click", function() {
          const barHeight = $("#categoryBar").outerHeight();
          const targetId = `#category-${CSS.escape(category.replace(/\s+/g, '_'))}`;
          const target = $(targetId);
          if (target.length) {
            $("html, body").stop(true).animate({ scrollTop: target.offset().top - barHeight - 10 }, 250, () => {
              setActiveCategory(category);
            });
          }
        });
        bar.append(button);
      });

      try {
        const last = localStorage.getItem(LAST_CATEGORY_KEY);
        if (last) setActiveCategory(last);
      } catch(e){}
    }

    // ==== Тоггл выбора ====
    function toggleDish(id) {
      const exists = wantList.some(d => d.id === id);
      if (exists) {
        wantList = wantList.filter(d => d.id !== id);
      } else {
        const dish = dishes.find(d => d.id === id);
        if (dish) wantList.push(dish);
      }
      renderWant();
      renderGroupedDishes();
    }

    // ==== Рендер блюд, сгруппированных по категориям ====
    function cardMarkup(dish, isAdded) {
      return `
        <div class="col fade-in-up">
          <div class="card h-100 ${isAdded ? 'selected' : ''}">
            <div class="media-wrapper">
              <img src="${dish.image}" loading="lazy" class="card-img-top" alt="${dish.name}" onerror="imgOnError(event)">
              <button class="img-toggle ${isAdded ? 'active' : ''}" data-id="${dish.id}" aria-pressed="${isAdded}" aria-label="${isAdded ? 'Убрать из списка' : 'Добавить в список'}" type="button">
                <!-- плюс -->
                <svg class="icon-plus" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M12 5v14M5 12h14"></path>
                </svg>
                <!-- галка -->
                <svg class="icon-check" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M20 6L9 17l-5-5"></path>
                </svg>
              </button>
              <div class="img-label">
                <span class="dish-name">${dish.name}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderGroupedDishes() {
      const grouped = {};
      dishes.forEach(dish => { (grouped[dish.category] ||= []).push(dish); });

      const container = $("#dishesContainer");
      container.empty();

      Object.keys(grouped)
        .sort((a,b) => a.localeCompare(b, 'ru'))
        .forEach(category => {
          container.append(`<h4 id="category-${category.replace(/\s+/g, '_')}" class="mt-4">${category}</h4>`);
          const row = $(`<div class="row row-cols-2 g-3"></div>`);
          grouped[category].forEach(dish => {
            const isAdded = wantList.some(w => w.id === dish.id);
            row.append(cardMarkup(dish, isAdded));
          });
          container.append(row);
        });

      $("#menuCount").text(dishes.length);
    }

    // ==== Рендер раздела «Хочу!» ====
    function renderWant() {
      const grid = $("#wantGrid");
      grid.empty();

      wantList.forEach(dish => {
        const isAdded = true;
        grid.append(cardMarkup(dish, isAdded));
      });

      $("#wantCount").text(wantList.length);
      updateEmptyState();
      persistWant();
    }

    // ==== Поделиться списком ====
    function shareWantedList() {
      if (wantList.length === 0) {
        alert("В списке пока ничего нет.");
        return;
      }
      const title = "Заказ по дома-меню";
      const listText = wantList.map((d, i) => `${i+1}. ${d.name}`).join("\n");
      const text = `Мой список блюд:\n${listText}`;

      if (navigator.share) {
        navigator.share({ title, text }).catch(err => console.error("Web Share API:", err));
        return;
      }
      if (tg && tg.showAlert) {
        tg.showAlert(text);
        return;
      }
      alert(text);
    }

    // ==== Загрузка данных ====
    function loadDishes() {
      $.getJSON("dishes.json", function(data) {
        dishes = data || [];
        restoreWant();
        renderCategoryBar();
        renderGroupedDishes();
        renderWant();
      }).fail(function() {
        console.error("Не удалось загрузить файл dishes.json, использую тестовые данные.");
        dishes = [
          {id: 1, name: "Стейк рибай", category: "Мясо", image: "images/steak_ribeye.jpg"},
          {id: 2, name: "Карпаччо из говядины", category: "Мясо", image: "images/carpaccio_beef.jpg"},
          {id: 3, name: "Дорадо на гриле", category: "Рыба", image: "images/dorado_grill.jpg"},
          {id: 4, name: "Том ям с креветками", category: "Супы", image: "images/tom_yum.jpg"},
          {id: 5, name: "Салат Цезарь", category: "Салаты", image: "images/caesar.jpg"},
          {id: 6, name: "Тирамису", category: "Десерты", image: "images/tiramisu.jpg"},
        ];
        renderCategoryBar();
        renderGroupedDishes();
        renderWant();
      });
    }

    // ==== Подсветка активной категории при скролле ====
    function throttle(fn, wait) {
      let last = 0;
      return function(...args) {
        const now = Date.now();
        if (now - last >= wait) {
          last = now;
          fn.apply(this, args);
        }
      }
    }

    const onScroll = throttle(function() {
      if (!$("#menuSection").is(":visible")) return;
      const scrollPos = $(document).scrollTop();
      const barHeight = $("#categoryBar").outerHeight();
      const currentSection = $("h4[id^='category-']").filter(function() {
        return ($(this).offset().top - barHeight - 20) <= scrollPos;
      }).last();
      if (!currentSection.length) return;
      const activeCategory = currentSection.text().trim();
      setActiveCategory(activeCategory);
    }, 100);

    // ==== Инициализация ====
    $(document).ready(function() {
      loadDishes();
      updateEmptyState();

      // Делегирование: клик по круглой кнопке на картинке
      $(document).on("click", ".img-toggle", function() {
        const id = parseInt($(this).data("id"));
        toggleDish(id);
      });

      $("#clearBtn").on("click", function() {
        if (wantList.length === 0) return;
        if (confirm("Очистить весь список «Хочу!»?")) {
          wantList = [];
          renderWant();
          renderGroupedDishes();
        }
      });

      $("#shareBtn").on("click", shareWantedList);

      $("#backToMenuBtn").on("click", function() {
        $("#menuSection").removeClass("hidden");
        $("#wantSection").addClass("hidden");
        $("#menuTab").addClass("active").attr("aria-selected", "true");
        $("#wantTab").removeClass("active").attr("aria-selected", "false");
        $("#categoryBar").show();
        updateShareBtnVisibility();
      });

      // Переключение табов
      $("#menuTab").on("click", function() {
        $("#menuSection").removeClass("hidden");
        $("#wantSection").addClass("hidden");
        $(this).addClass("active").attr("aria-selected", "true");
        $("#wantTab").removeClass("active").attr("aria-selected", "false");
        $("#categoryBar").show();
        updateShareBtnVisibility();
      });

      $("#wantTab").on("click", function() {
        $("#menuSection").addClass("hidden");
        $("#wantSection").removeClass("hidden");
        $(this).addClass("active").attr("aria-selected", "true");
        $("#menuTab").removeClass("active").attr("aria-selected", "false");
        $("#categoryBar").hide();
        updateShareBtnVisibility();
      });

      // Скролл
      $(window).on("scroll", onScroll);
    });
  </script>
</body>
</html>
